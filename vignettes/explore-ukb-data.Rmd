---
title: "Explore UK Biobank data"
author: "Ken B. Hanscombe"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(
  fig.retina = 2,
  eval = FALSE,
  warning = FALSE,
  message = FALSE,
  comment = NA
)

```

<br>

After downloading and decrypting your UK Biobank (UKB) data with the supplied [UKB programs](http://biobank.ctsu.ox.ac.uk/crystal/docs/UsingUKBData.pdf), you have multiple files that need to be brought together to give you a tidy dataset to explore. The data file has column names that are the numeric field codes from the [UKB data showcase](http://www.ukbiobank.ac.uk/about-data-showcase/). `ukbtools` removes all the upfront data wrangling required to get a single dataset for statistical analysis, and provides tools to assist in quality control, query of disease diagnoses, and retrieval of genetic metadata. 

<br>
<br>




## 1. Preparing a UKB fileset

Download^§^ then decrypt your data and create a UKB fileset (.tab, .r, .html):

```{bash}
ukb_unpack ukbxxxx.enc key
ukb_conv ukbxxxx.enc_ukb r
ukb_conv ukbxxxx.enc_ukb docs

```


`ukb_unpack` decrypts your downloaded `ukbxxxx.enc` file, outputting a `ukbxxxx.enc_ukb` file. `ukb_conv` with the `r` flag converts the decrypted data to a tab-delimited file `ukbxxxx.tab` and an R script `ukbxxxx.r` that reads the tab file. The `docs` flag creates an html file containing a field-code-to-description table (among others).

<br>

^§^ Full details of the data download and decrypt process are given in the [Using UK Biobank Data](http://biobank.ctsu.ox.ac.uk/crystal/docs/UsingUKBData.pdf) documentation .

<br>
<br>




## 2. Making a dataset

The function `ukb_df()` takes two arguments, the stem of your fileset and the path, and returns a dataframe with usable column names. 


```{r}

library(ukbtools)

my_ukb_data <- ukb_df("ukbxxxx")

```


You can also specify the path to your fileset if it is not in the current directory. For example, if your fileset is in a subdirectory of the working directory called `data`


```{r}

my_ukb_data <- ukb_df("ukbxxxx", path = "/full/path/to/my/fileset")

```


Use `ukb_df_field` to create a field-to-descriptive name key.

<br>

__Note:__ You can move the three files in your fileset after creating them with `ukb_conv`, but they should be kept together. `ukb_df()` automatically updates the read call in the R source file to point to the correct directory (the current directly by default, or the directory specified by `path`).

<br>

<br>

> __Memory and efficiency__
>
> I highly recommend saving your new UKB dataset with `save(my_ukb_data, file = "my_ukb_data.rda")`. You can load the data with `load("my_ukb_data.rda")`. Creating a UKB dataset from my largest UKB fileset which included a 2.6 GB .tab file, took approximately 10 mins; loading the same dataset after the `save` procedure, took about 20 seconds. The saved file was about 200 MB.

<br>
<br>


#### 2.1 Multiple downloads

If you have multiple UKB downloads, tidy then merge them.


```{r}

ukbxxxx_data <- ukb_df("ukbxxxx")
ukbyyyy_data <- ukb_df("ukbyyyy")
ukbzzzz_data <- ukb_df("ukbzzzz")

# Merge with your preferred method
my_ukb_data <- plyr::join_all(
  list(ukbxxxx_data, ukbyyyy_data, ukbzzzz_data),
  by = "eid",
  type = "full"
)

```

<br>

__Note:__ You will have at least one variable duplicated in the different downloads, the unique individual identifier `eid`. Counting the repeated variables (and the number of repeats of each) can give you a sense of the expected number of variables in your merged dataset.

```{r}

ukb_names <- c(
  names(ukbxxxx_data),
  names(ukbyyyy_data),
  names(ukbzzzz_data)
)

count_ukb_names <- data.frame(table(ukb_names))
dim(count_ukb_names[count_names$Freq > 1, ])

```


<br>
<br>




## 3. Exploring primary demographics of a UKB subset

As an exploratory step you might want to look at the demographics of a particular subset of the UKB sample relative to a reference sample. For example, using the `nonmiss.var` argument of `ukb_context` will produce a plot of the primary demographics (sex, age, ethnicity, and Townsend deprivation score) and employment status and assessment centre, for the subsample with data on your variable of interest compared to those without data (i.e. `NA`).

```{r}

ukb_context(my_ukb_data, nonmiss.var = "my_variable_of_interest")

```

<br>

It is also possible to supply a logical vector with `subset.var` to define the subset and reference sample. This is particularly useful for understanding a subgroup within the UKB study, e.g., obese individuals below age 50.

```{r}

subgroup_of_interest <- (my_ukb_data$bmi > 40 & my_ukb_data$age < 50) 
ukb_context(my_ukb_data, subset.var = subgroup_of_interest)

```


<br>
<br>


## 4. Retreiving ICD diagnoses


All ICD related functions begin `ukb_icd_`. Type `ukb_icd_` tab to see the family of functions. The full ICD "code-meaning" tables are available as datasets (`icd9codes`, `icd10codes`). ICD chapter-level tables describing disease blocks are also available for query as datasets (`icd9chapters`, `icd10chapters`)

<br>

To retrieve the full diagnosis of an individual

```{r}

ukb_icd_diagnosis(my_ukb_data, id = "0000000", icd.version = 10)

```

<br>


To retrieve the "meaning" of an ICD code use `icd_code`. You can look up multiple codes by concatenating them.

```{r}

ukb_icd_code_meaning(icd.code = "I74", icd.version = 10)

```

<br>

Search for a class of diseases with a keyword

```{r}

ukb_icd_keyword("cardio", icd.version = 10)

```

<br>

You can calculate the prevalence of a diagnosis in the UKB study (or a subset of the full sample) using `ukb_icd_prevalence`. The `icd.diagnosis` argument takes a regular expression, and so can also be used to retrieve prevalence of a disease "class", i.e., the proportion of individuals with _any_ diagnosis in the disease class.

```{r}

# ICD-10 code I74, Arterial embolism and thrombosis
ukb_icd_prevalence(my_ukb_data, icd.version = 10, icd.diagnosis = "I74")

# ICD-10 chapter 9, disease block I00–I99, Diseases of the circulatory system
ukb_icd_prevalence(my_ukb_data, icd.version = 10, icd.diagnosis = "I")

# ICD-10 chapter 2, C00-D49, Neoplasms 
ukb_icd_prevalence(my_ukb_data, icd.version = 10, icd.diagnosis = "C|D[0-4].")

```


<br>
<br>





## 5. Retrieving genetic metadata

If you are doing any downstream genetic analyses, you will need the genetic metadata (which should be in you phenotype dataset). Detailed information is available on UKB [genotyping and quality control](http://www.ukbiobank.ac.uk/wp-content/uploads/2014/04/UKBiobank_genotyping_QC_documentation-web.pdf) and [imputation and association](http://www.ukbiobank.ac.uk/wp-content/uploads/2014/04/imputation_documentation_May2015.pdf).

All genetic metadata related functions begin `ukb_gen_`. Typing `ukb_gen_` tab opens a dropdown menu for this group of functions. 

<br>
<br>

You can collect the genetic metadata (including recommended exclusions, genetic sex, genetic ethnicity, chip, etc.), and principal components with

```{r}

my_gen_meta <- ukb_gen_meta(my_ukb_data)
my_gen_pcs <- ukb_gen_pcs(my_ukb_data)

```

<br>
<br>

A list of IDs for recommended exclusions and heterozygosity outliers (+/- 3*SD) can be retreived

```{r}

ukb_gen_excl(my_ukb_data)
ukb_gen_het(my_ukb_data)

```

For a `data.frame` of raw heterozygosity data

```{r}

ukb_gen_het(my_ukb_data, all.het = TRUE)

```


<br>
<br>

`ukb_gen_rel` returns a `data.frame` with `id`, `pair` (a numeric identifier for related pairs), and `kinship` (kinship coefficient). For a count of related samples by degree of relatedness use `ukb_gen_rel_count`. Set the argument `plot = TRUE` to replicate the plot on page 15 of the [UKB genotyping and quality control documentation](http://www.ukbiobank.ac.uk/wp-content/uploads/2014/04/UKBiobank_genotyping_QC_documentation-web.pdf), for your subgroup of interest.

```{r}

my_gen_rel <- ukb_gen_rel(my_ukb_data)

# To get a count and plot of degree of relatedness
ukb_gen_rel_count(my_ukb_data, plot = TRUE)

```


<br>
<br>
